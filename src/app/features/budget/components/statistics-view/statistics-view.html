<div class="flex flex-col gap-4">
    <!-- Statistics Header -->
    <div class="gradient-card p-4 rounded-sm">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-dash-text">
                Statistik - {{ selectedMonthName }}
                @if (selectedAccountName) {
                <span class="text-dash-text-dim text-sm font-normal ml-2">
                    ({{ selectedAccountName }})
                </span>
                }
            </h2>
            <div class="text-xs text-dash-text-dim">
                {{ transactionCount }} Transaktionen
            </div>
        </div>
    </div>

    <!-- Summary Cards Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Total Income Card -->
        <div class="gradient-card p-4 rounded-sm">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-sm bg-green-500/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-green-500">trending_up</span>
                </div>
                <div>
                    <div class="text-xs text-dash-text-dim uppercase tracking-wider">Einnahmen</div>
                    <div class="text-xl font-bold text-green-500">+{{ formatCurrency(stats.income) }}</div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">
                {{ incomeTransactionCount }} Transaktionen
            </div>
        </div>

        <!-- Total Expenses Card -->
        <div class="gradient-card p-4 rounded-sm">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-sm bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-red-500">trending_down</span>
                </div>
                <div>
                    <div class="text-xs text-dash-text-dim uppercase tracking-wider">Ausgaben</div>
                    <div class="text-xl font-bold text-red-500">-{{ formatCurrency(stats.expenses) }}</div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">
                {{ expenseTransactionCount }} Transaktionen
            </div>
        </div>

        <!-- Net Balance Card -->
        <div class="gradient-card p-4 rounded-sm">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-sm bg-dash-accent/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-dash-accent">account_balance</span>
                </div>
                <div>
                    <div class="text-xs text-dash-text-dim uppercase tracking-wider">Netto</div>
                    <div class="text-xl font-bold" [class.text-green-500]="stats.income - stats.expenses >= 0"
                        [class.text-red-500]="stats.income - stats.expenses < 0">
                        {{ stats.income - stats.expenses >= 0 ? '+' : '' }}{{
                        formatCurrency(stats.income - stats.expenses) }}
                    </div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">
                Differenz Einnahmen - Ausgaben
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Expenses by Category (Pie Chart) -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <h3 class="text-sm font-bold text-dash-text-dim uppercase tracking-wider mb-4">Ausgaben nach
                Kategorie</h3>

            @if (categoryStats.length > 0) {
            <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-6">
                <!-- Pie Chart -->
                <div class="relative w-28 h-28 sm:w-32 sm:h-32 flex-shrink-0">
                    <div class="w-full h-full rounded-full" [style.background]="pieChartGradient">
                    </div>
                    <div class="absolute inset-3 sm:inset-4 bg-dash-card rounded-full flex items-center justify-center">
                        <span class="text-[10px] sm:text-xs text-dash-text-dim font-mono">{{
                            formatCurrency(stats.expenses) }}</span>
                    </div>
                </div>

                <!-- Legend -->
                <div class="flex-1 w-full space-y-2 max-h-48 overflow-y-auto">
                    @for (stat of categoryStats; track stat.name) {
                    <div class="flex items-center justify-between text-xs sm:text-sm">
                        <div class="flex items-center gap-2 min-w-0">
                            <div class="w-3 h-3 rounded-sm flex-shrink-0" [style.background-color]="stat.color"></div>
                            <span class="text-dash-text truncate">{{ stat.name }}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                            <span class="text-dash-text-dim font-mono text-[10px] sm:text-xs">{{
                                stat.percentage |
                                number:'1.1-1' }}%</span>
                            <span class="text-dash-text font-mono text-[10px] sm:text-xs hidden sm:inline">{{
                                formatCurrency(stat.amount)
                                }}</span>
                        </div>
                    </div>
                    }
                </div>
            </div>
            } @else {
            <div class="text-center py-8 text-dash-text-dim text-sm">
                Keine Ausgaben in diesem Monat
            </div>
            }
        </div>

        <!-- Income by Category -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <h3 class="text-sm font-bold text-dash-text-dim uppercase tracking-wider mb-4">Einnahmen nach
                Kategorie</h3>

            @if (incomeCategoryStats.length > 0) {
            <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-6">
                <!-- Pie Chart -->
                <div class="relative w-28 h-28 sm:w-32 sm:h-32 flex-shrink-0">
                    <div class="w-full h-full rounded-full" [style.background]="incomePieChartGradient"></div>
                    <div class="absolute inset-3 sm:inset-4 bg-dash-card rounded-full flex items-center justify-center">
                        <span class="text-[10px] sm:text-xs text-dash-text-dim font-mono">{{
                            formatCurrency(stats.income) }}</span>
                    </div>
                </div>

                <!-- Legend -->
                <div class="flex-1 w-full space-y-2 max-h-48 overflow-y-auto">
                    @for (stat of incomeCategoryStats; track stat.name) {
                    <div class="flex items-center justify-between text-xs sm:text-sm">
                        <div class="flex items-center gap-2 min-w-0">
                            <div class="w-3 h-3 rounded-sm flex-shrink-0" [style.background-color]="stat.color"></div>
                            <span class="text-dash-text truncate">{{ stat.name }}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                            <span class="text-dash-text-dim font-mono text-[10px] sm:text-xs">{{
                                stat.percentage |
                                number:'1.1-1' }}%</span>
                            <span class="text-dash-text font-mono text-[10px] sm:text-xs hidden sm:inline">{{
                                formatCurrency(stat.amount)
                                }}</span>
                        </div>
                    </div>
                    }
                </div>
            </div>
            } @else {
            <div class="text-center py-8 text-dash-text-dim text-sm">
                Keine Einnahmen in diesem Monat
            </div>
            }
        </div>
    </div>

    <!-- Trend Chart -->
    <div class="gradient-card p-4 rounded-sm">
        <h3 class="text-sm font-bold text-dash-text-dim uppercase tracking-wider mb-4">Monatlicher Trend
        </h3>

        <div class="relative h-48">
            <!-- SVG Line Chart -->
            <svg class="w-full h-full" viewBox="0 0 100 60" preserveAspectRatio="none">
                <!-- Grid lines -->
                <line x1="0" y1="15" x2="100" y2="15" stroke="#333" stroke-width="0.2" />
                <line x1="0" y1="30" x2="100" y2="30" stroke="#333" stroke-width="0.2" />
                <line x1="0" y1="45" x2="100" y2="45" stroke="#333" stroke-width="0.2" />

                <!-- Zero line -->
                <line x1="0" [attr.y1]="zeroLineY" x2="100" [attr.y2]="zeroLineY" stroke="#666" stroke-width="0.3"
                    stroke-dasharray="2,2" />

                <!-- Area fill -->
                <polygon [attr.points]="trendAreaPoints" fill="url(#trendGradient)" opacity="0.3" />

                <!-- Trend line -->
                <polyline [attr.points]="trendPoints" fill="none"
                    [attr.stroke]="themeService.currentAccentColor().value" stroke-width="0.5" stroke-linecap="round"
                    stroke-linejoin="round" />

                <!-- Gradient definition -->
                <defs>
                    <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%"
                            [attr.style]="'stop-color:' + themeService.currentAccentColor().value + ';stop-opacity:0.5'" />
                        <stop offset="100%"
                            [attr.style]="'stop-color:' + themeService.currentAccentColor().value + ';stop-opacity:0'" />
                    </linearGradient>
                </defs>
            </svg>

            <!-- Y-axis labels -->
            <div
                class="absolute left-0 top-0 h-full flex flex-col justify-between text-[10px] text-dash-text-dim font-mono">
                <span>{{ formatCurrency(trendMaxValue) }}</span>
                <span>{{ formatCurrency(trendMaxValue / 2) }}</span>
                <span>0</span>
                <span>{{ formatCurrency(trendMinValue) }}</span>
            </div>
        </div>

        <!-- X-axis labels -->
        <div class="flex justify-between mt-2 text-[10px] text-dash-text-dim font-mono">
            <span>1</span>
            <span>{{ Math.ceil(daysInSelectedMonth / 4) }}</span>
            <span>{{ Math.ceil(daysInSelectedMonth / 2) }}</span>
            <span>{{ Math.ceil(daysInSelectedMonth * 3 / 4) }}</span>
            <span>{{ daysInSelectedMonth }}</span>
        </div>
    </div>

    <!-- Daily Breakdown -->
    <div class="gradient-card p-3 md:p-4 rounded-sm">
        <h3 class="text-sm font-bold text-dash-text-dim uppercase tracking-wider mb-4">Tägliche Übersicht
        </h3>

        <div class="grid grid-cols-7 gap-0.5 sm:gap-1">
            @for (day of dailyTrend; track day.day) {
            <div class="p-1 sm:p-2 rounded-sm text-center text-[10px] sm:text-xs"
                [class.bg-green-500/20]="day.income > day.expense" [class.bg-red-500/20]="day.expense > day.income"
                [class.bg-dash-bg]="day.income === 0 && day.expense === 0"
                [title]="'Tag ' + day.day + ': +' + formatCurrency(day.income) + ' / -' + formatCurrency(day.expense)">
                <div class="font-bold text-dash-text">{{ day.day }}</div>
                @if (day.income > 0 || day.expense > 0) {
                <div class="text-[8px] sm:text-[9px] font-mono hidden sm:block"
                    [class.text-green-500]="day.income > day.expense" [class.text-red-500]="day.expense > day.income">
                    {{ day.income > day.expense ? '+' : '-' }}{{ formatCurrency(Math.abs(day.income -
                    day.expense)) }}
                </div>
                }
            </div>
            }
        </div>
    </div>

    <!-- Top Expenses -->
    <div class="gradient-card p-3 md:p-4 rounded-sm">
        <h3 class="text-sm font-bold text-dash-text-dim uppercase tracking-wider mb-4">Top 10 Ausgaben</h3>

        @if (topExpenses.length > 0) {
        <div class="space-y-2">
            @for (transaction of topExpenses; track transaction.id; let i = $index) {
            <div class="flex items-center justify-between p-2 bg-dash-bg rounded-sm gap-2">
                <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                    <span class="text-dash-text-dim font-mono text-xs w-4 sm:w-5 flex-shrink-0">{{ i + 1
                        }}.</span>
                    <div class="min-w-0">
                        <div class="text-xs sm:text-sm text-dash-text truncate">{{ transaction.description
                            }}</div>
                        <div class="text-[10px] sm:text-xs text-dash-text-dim truncate">{{
                            transaction.category }} • {{ formatDate(transaction.date)
                            }}</div>
                    </div>
                </div>
                <span class="font-mono font-bold text-red-500 text-xs sm:text-sm flex-shrink-0">-{{
                    formatCurrency(transaction.amount)
                    }}</span>
            </div>
            }
        </div>
        } @else {
        <div class="text-center py-4 text-dash-text-dim text-sm">
            Keine Ausgaben in diesem Monat
        </div>
        }
    </div>

    <!-- Average Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4">
        <div class="gradient-card p-3 md:p-4 rounded-sm text-center">
            <div class="text-[10px] sm:text-xs text-dash-text-dim uppercase tracking-wider mb-1">Ø Tägl.
                Ausgaben</div>
            <div class="text-sm sm:text-lg font-bold text-red-500">{{
                formatCurrency(averageDailyExpense) }}</div>
        </div>
        <div class="gradient-card p-3 md:p-4 rounded-sm text-center">
            <div class="text-[10px] sm:text-xs text-dash-text-dim uppercase tracking-wider mb-1">Ø Tägl.
                Einnahmen</div>
            <div class="text-sm sm:text-lg font-bold text-green-500">{{
                formatCurrency(averageDailyIncome) }}
            </div>
        </div>
        <div class="gradient-card p-3 md:p-4 rounded-sm text-center">
            <div class="text-[10px] sm:text-xs text-dash-text-dim uppercase tracking-wider mb-1">Größte
                Ausgabe</div>
            <div class="text-sm sm:text-lg font-bold text-red-500">{{ formatCurrency(largestExpense) }}
            </div>
        </div>
        <div class="gradient-card p-3 md:p-4 rounded-sm text-center">
            <div class="text-[10px] sm:text-xs text-dash-text-dim uppercase tracking-wider mb-1">Größte
                Einnahme</div>
            <div class="text-sm sm:text-lg font-bold text-green-500">{{ formatCurrency(largestIncome)
                }}</div>
        </div>
    </div>
</div>