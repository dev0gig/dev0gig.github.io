<!-- Right Sidebar (Permanent, toggleable) -->
<div class="sidebar-container fixed top-0 right-0 h-full w-72 z-[60] flex flex-col gap-4 p-4 overflow-y-auto transform transition-transform duration-300 ease-in-out"
    [class.translate-x-0]="sidebarService.isRightOpen()" [class.translate-x-full]="!sidebarService.isRightOpen()">

    <!-- Header -->
    <div class="flex items-center justify-between pb-2 border-b border-dash-border">
        <button (click)="toggleSidebar()" class="text-dash-text-dim hover:text-white transition-colors">
            <span class="material-symbols-sharp">chevron_right</span>
        </button>
        <h2 class="text-lg font-bold text-dash-text">Widgets</h2>
    </div>

    <!-- Clock Widget -->
    <div class="gradient-card p-4">
        <div class="flex items-center gap-2 mb-2">
            <span class="material-symbols-sharp text-dash-accent">schedule</span>
            <span class="text-sm font-medium text-dash-text-dim uppercase tracking-wider">Uhrzeit</span>
        </div>

        <!-- Time Display -->
        <div class="text-center">
            <div class="text-4xl font-bold text-white tracking-wider font-mono">
                {{ currentTime() }}
            </div>
            <div class="text-base text-dash-accent font-medium capitalize mt-1">
                {{ currentDay() }}
            </div>
            <div class="flex justify-center items-center gap-2 text-sm text-dash-text-dim mt-1">
                <span>{{ currentDate() }}</span>
                <span class="opacity-50">•</span>
                <span>KW {{ currentWeek() }}</span>
            </div>
        </div>
    </div>

    <!-- Weather Widget -->
    <div class="gradient-card p-4">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <span class="material-symbols-sharp text-dash-accent">cloud</span>
                <span class="text-sm font-medium text-dash-text-dim uppercase tracking-wider">Wetter</span>
            </div>
            <button (click)="loadWeather()" class="text-dash-text-dim hover:text-dash-accent transition-colors"
                [class.animate-spin]="weatherLoading()">
                <span class="material-symbols-sharp text-lg">refresh</span>
            </button>
        </div>

        <!-- Loading State -->
        @if (weatherLoading()) {
        <div class="flex items-center justify-center py-6">
            <div class="animate-pulse flex flex-col items-center gap-2">
                <span class="material-symbols-sharp text-4xl text-dash-text-dim">cloud</span>
                <span class="text-sm text-dash-text-dim">Wird geladen...</span>
            </div>
        </div>
        }

        <!-- Error State -->
        @if (weatherError() && !weatherLoading()) {
        <div class="flex items-center justify-center py-4 text-center">
            <div class="flex flex-col items-center gap-2">
                <span class="material-symbols-sharp text-3xl text-red-400">error</span>
                <span class="text-sm text-dash-text-dim">{{ weatherError() }}</span>
            </div>
        </div>
        }

        <!-- Weather Content -->
        @if (currentWeather() && !weatherLoading() && !weatherError()) {
        <!-- Current Weather -->
        <div class="text-center mb-4">
            <div class="flex items-center justify-center gap-2 text-dash-text-dim text-xs mb-2">
                <span class="material-symbols-sharp text-sm">location_on</span>
                <span>{{ currentWeather()!.location }}</span>
            </div>
            <div class="flex items-center justify-center gap-1">
                <img [src]="getWeatherIcon(currentWeather()!.weatherCode)" alt="Weather icon" class="w-20 h-20 -ml-3">
                <div class="text-left">
                    <div class="text-4xl font-bold text-white">{{ currentWeather()!.temperature }}°</div>
                    <div class="text-sm text-dash-text-dim">{{ getWeatherDescription(currentWeather()!.weatherCode) }}
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-3 text-xs text-dash-text-dim">
                <div class="flex items-center gap-1">
                    <span class="material-symbols-sharp text-sm">air</span>
                    <span>{{ currentWeather()!.windSpeed }} km/h</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="material-symbols-sharp text-sm">humidity_percentage</span>
                    <span>{{ currentWeather()!.humidity }}%</span>
                </div>
            </div>
        </div>

        <!-- Forecast Divider -->
        <div class="border-t border-dash-border my-3"></div>

        <!-- 3-Day Forecast -->
        <div class="flex justify-between">
            @for (day of forecast(); track day.date; let i = $index) {
            <div class="flex flex-col items-center gap-1 flex-1">
                <span class="text-xs text-dash-text-dim font-medium">{{ getDayName(day.date, i) }}</span>
                <img [src]="getWeatherIcon(day.weatherCode)" alt="Weather forecast" class="w-12 h-12 -my-2">
                <div class="text-xs">
                    <span class="text-white font-semibold">{{ day.tempMax }}°</span>
                    <span class="text-dash-text-dim">/{{ day.tempMin }}°</span>
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- Journal Widget -->
    <div class="gradient-card p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="material-symbols-sharp text-dash-accent">book</span>
                <span class="text-sm font-medium text-dash-text-dim uppercase tracking-wider">Journal</span>
            </div>
            <a routerLink="/journal" class="text-dash-text-dim hover:text-dash-accent transition-colors">
                <span class="material-symbols-sharp text-lg">arrow_forward</span>
            </a>
        </div>

        <!-- Entry Count Display -->
        <div class="text-center mt-3">
            <div class="text-3xl font-bold text-white">{{ totalJournalEntries() }}</div>
            <div class="text-xs text-dash-text-dim">Einträge</div>
        </div>
    </div>

    <!-- Budget Widget -->
    <div class="gradient-card p-4">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <span class="material-symbols-sharp text-dash-accent">account_balance_wallet</span>
                <span class="text-sm font-medium text-dash-text-dim uppercase tracking-wider">Budget</span>
            </div>
            <a routerLink="/budget" class="text-dash-text-dim hover:text-dash-accent transition-colors">
                <span class="material-symbols-sharp text-lg">arrow_forward</span>
            </a>
        </div>

        <!-- Trend Chart -->
        @if (budgetTrendData().length > 1) {
        <div class="bg-black/20 rounded-lg p-2">
            <div class="text-xs text-dash-text-dim text-center mb-2">Trend (letzte 5 Tage)</div>
            <svg viewBox="0 0 100 50" class="w-full h-16" preserveAspectRatio="none">
                <!-- Grid lines -->
                <line x1="0" y1="20" x2="100" y2="20" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"
                    stroke-dasharray="2,2" />

                <!-- Area fill -->
                <polygon [attr.points]="getBudgetTrendAreaPoints()"
                    [attr.fill]="budgetStats().totalBalance >= 0 ? 'rgba(74, 222, 128, 0.2)' : 'rgba(248, 113, 113, 0.2)'" />

                <!-- Trend line -->
                <polyline [attr.points]="getBudgetTrendLinePoints()" fill="none"
                    [attr.stroke]="budgetStats().totalBalance >= 0 ? '#4ade80' : '#f87171'" stroke-width="1.5"
                    stroke-linecap="round" stroke-linejoin="round" />

                <!-- End point dot -->
                @let lastPoint = getLastTrendPoint();
                @if (lastPoint) {
                <circle [attr.cx]="lastPoint.x" [attr.cy]="lastPoint.y" r="2"
                    [attr.fill]="budgetStats().totalBalance >= 0 ? '#4ade80' : '#f87171'" />
                }

                <!-- X-Axis Day Labels -->
                @for (day of budgetTrendData(); track day.date; let i = $index) {
                <text [attr.x]="(i / (budgetTrendData().length - 1)) * 100" y="48" font-size="5"
                    fill="rgba(255,255,255,0.5)" text-anchor="middle">
                    {{ getTrendDayLabel(day.date, i) }}
                </text>
                }
            </svg>
        </div>
        }
    </div>
</div>