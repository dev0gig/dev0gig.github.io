<div class="flex flex-col gap-4">
    <!-- Fixed Costs Header -->
    <div class="gradient-card p-3 md:p-4 rounded-sm">
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 md:gap-4">
            <h2 class="text-lg font-bold text-dash-text whitespace-nowrap">Fixkosten</h2>
            <div class="flex gap-2">
                <button (click)="exportPdf()"
                    class="bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-3 md:px-4 py-2 rounded-sm text-sm font-medium flex items-center justify-center gap-2 whitespace-nowrap border border-dash-border transition-colors"
                    title="Als PDF exportieren">
                    <span class="material-symbols-sharp text-lg">picture_as_pdf</span>
                    <span class="hidden sm:inline">PDF Export</span>
                </button>
                <button (click)="onAddGroup()"
                    class="bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-3 md:px-4 py-2 rounded-sm text-sm font-medium flex items-center justify-center gap-2 whitespace-nowrap border border-dash-border transition-colors">
                    <span class="material-symbols-sharp text-lg">folder_open</span>
                    <span class="hidden sm:inline">Neue Gruppe</span>
                </button>
                <button (click)="onAddFixedCost()"
                    class="gradient-btn text-white px-3 md:px-4 py-2 rounded-sm text-sm font-medium flex items-center justify-center gap-2 whitespace-nowrap">
                    <span class="material-symbols-sharp text-lg">add</span>
                    <span>Neue Fixkosten</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Fixed Costs Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
        <!-- Fixed Income Card -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <div class="flex items-center gap-2 md:gap-3 mb-2">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-sm bg-green-500/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-green-500 text-lg md:text-2xl">trending_up</span>
                </div>
                <div class="min-w-0">
                    <div class="text-[10px] md:text-xs text-dash-text-dim uppercase tracking-wider truncate">Einnahmen
                    </div>
                    <div class="text-base md:text-xl font-bold text-green-500">+{{ formatCurrency(fixedIncomeTotal) }}
                    </div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">{{ fixedIncomeCount }} Eintr채ge</div>
        </div>

        <!-- Fixed Expenses Card -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <div class="flex items-center gap-2 md:gap-3 mb-2">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-sm bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-red-500 text-lg md:text-2xl">trending_down</span>
                </div>
                <div class="min-w-0">
                    <div class="text-[10px] md:text-xs text-dash-text-dim uppercase tracking-wider truncate">Ausgaben
                    </div>
                    <div class="text-base md:text-xl font-bold text-red-500">-{{ formatCurrency(fixedCostsTotal) }}
                    </div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">{{ fixedExpenseCount }} Eintr채ge</div>
        </div>

        <!-- Fixed Transfers Card -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <div class="flex items-center gap-2 md:gap-3 mb-2">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-sm bg-purple-500/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-purple-500 text-lg md:text-2xl">swap_horiz</span>
                </div>
                <div class="min-w-0">
                    <div class="text-[10px] md:text-xs text-dash-text-dim uppercase tracking-wider truncate">Transfers
                    </div>
                    <div class="text-base md:text-xl font-bold text-purple-500">{{ formatCurrency(fixedTransferTotal) }}
                    </div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">{{ fixedTransferCount }} Eintr채ge</div>
        </div>

        <!-- Net Fixed Costs Card -->
        <div class="gradient-card p-3 md:p-4 rounded-sm">
            <div class="flex items-center gap-2 md:gap-3 mb-2">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-sm bg-dash-accent/20 flex items-center justify-center">
                    <span class="material-symbols-sharp text-dash-accent text-lg md:text-2xl">account_balance</span>
                </div>
                <div class="min-w-0">
                    <div class="text-[10px] md:text-xs text-dash-text-dim uppercase tracking-wider truncate">Netto</div>
                    <div class="text-base md:text-xl font-bold"
                        [class.text-green-500]="fixedIncomeTotal - fixedCostsTotal >= 0"
                        [class.text-red-500]="fixedIncomeTotal - fixedCostsTotal < 0">
                        {{ fixedIncomeTotal - fixedCostsTotal >= 0 ? '+' : '' }}{{ formatCurrency(fixedIncomeTotal -
                        fixedCostsTotal) }}
                    </div>
                </div>
            </div>
            <div class="text-xs text-dash-text-dim">Differenz</div>
        </div>
    </div>

    <!-- Fixed Costs List Container -->
    <div class="gradient-card rounded-sm" cdkDropListGroup>
        @if (fixedCosts.length === 0) {
        <div class="p-8 text-center">
            <span class="material-symbols-sharp text-4xl text-dash-text-dim mb-4 block">bookmark</span>
            <p class="text-dash-text-dim text-sm">Keine Fixkosten definiert.</p>
            <p class="text-dash-text-dim text-xs mt-2">Klicken Sie auf "Neue Fixkosten" um welche hinzuzuf체gen.</p>
        </div>
        } @else {

        <!-- Ungrouped Fixed Costs -->
        @if (getFixedCostsByGroup(null).length > 0) {
        <div class="border-b border-dash-border">
            <div class="p-3 md:p-4 bg-dash-bg/50 border-b border-dash-border">
                <div class="flex items-center gap-2 text-dash-text-dim">
                    <span class="material-symbols-sharp text-lg">list</span>
                    <span class="font-medium text-sm">Ohne Gruppe</span>
                    <span class="text-xs">({{ getFixedCostsByGroup(null).length }})</span>
                </div>
            </div>
            <div cdkDropList [cdkDropListData]="getFixedCostsByGroup(null)" (cdkDropListDropped)="onDrop($event)"
                data-group-id="null" class="min-h-[20px]">
                @for (fixedCost of getFixedCostsByGroup(null); track fixedCost.id) {
                <!-- Drag Wrapper -->
                <div cdkDrag [cdkDragData]="fixedCost" [cdkDragDisabled]="expandedFixedCostId() === fixedCost.id">
                    <div class="fixed-cost-placeholder" *cdkDragPlaceholder></div>

                    <app-fixed-cost-item [fixedCost]="fixedCost" [accounts]="accounts" [categories]="categories"
                        [groups]="getSortedGroups()" [isExpanded]="expandedFixedCostId() === fixedCost.id"
                        [isEditing]="isEditingInline(fixedCost.id)" (expand)="toggleExpansion($event)"
                        (toggleEdit)="toggleInlineEdit($event)" (cancelEdit)="cancelInlineEdit($event)"
                        (save)="onSaveFixedCost(fixedCost.id, $event)" (delete)="onDeleteFixedCost($event)"
                        (book)="onCreateTransaction($event)">
                    </app-fixed-cost-item>
                </div>
                }
            </div>
        </div>
        }

        <!-- Grouped Fixed Costs -->
        @for (group of getSortedGroups(); track group.id) {
        <div class="border-b border-dash-border last:border-b-0">
            <div class="p-3 md:p-4 bg-dash-bg/50 border-b border-dash-border flex items-center justify-between cursor-pointer hover:bg-dash-card-hover transition-colors"
                (click)="toggleGroupCollapsed(group.id)">
                <div class="flex items-center gap-2 text-dash-text">
                    <span class="material-symbols-sharp text-lg transition-transform"
                        [class.rotate-0]="!isGroupCollapsed(group.id)"
                        [class.-rotate-90]="isGroupCollapsed(group.id)">expand_more</span>
                    <span class="material-symbols-sharp text-lg text-dash-accent">folder</span>
                    <span class="font-medium text-sm">{{ group.name }}</span>
                    <span class="text-xs text-dash-text-dim">({{ getFixedCostsByGroup(group.id).length }})</span>
                </div>
                <div class="flex items-center gap-2">
                    <button (click)="onEditGroup(group); $event.stopPropagation()"
                        class="p-1 hover:bg-dash-card text-dash-text-dim hover:text-white rounded-sm transition-colors">
                        <span class="material-symbols-sharp text-sm">edit</span>
                    </button>
                    <button (click)="onDeleteGroup(group.id); $event.stopPropagation()"
                        class="p-1 hover:bg-red-500/20 text-dash-text-dim hover:text-red-500 rounded-sm transition-colors">
                        <span class="material-symbols-sharp text-sm">delete</span>
                    </button>
                </div>
            </div>
            @if (!isGroupCollapsed(group.id)) {
            <div cdkDropList [cdkDropListData]="getFixedCostsByGroup(group.id)" (cdkDropListDropped)="onDrop($event)"
                [attr.data-group-id]="group.id" class="min-h-[20px]">
                @for (fixedCost of getFixedCostsByGroup(group.id); track fixedCost.id) {
                <div cdkDrag [cdkDragData]="fixedCost" [cdkDragDisabled]="expandedFixedCostId() === fixedCost.id">
                    <div class="fixed-cost-placeholder" *cdkDragPlaceholder></div>
                    <app-fixed-cost-item [fixedCost]="fixedCost" [accounts]="accounts" [categories]="categories"
                        [groups]="getSortedGroups()" [isExpanded]="expandedFixedCostId() === fixedCost.id"
                        [isEditing]="isEditingInline(fixedCost.id)" (expand)="toggleExpansion($event)"
                        (toggleEdit)="toggleInlineEdit($event)" (cancelEdit)="cancelInlineEdit($event)"
                        (save)="onSaveFixedCost(fixedCost.id, $event)" (delete)="onDeleteFixedCost($event)"
                        (book)="onCreateTransaction($event)">
                    </app-fixed-cost-item>
                </div>
                }
                @if (getFixedCostsByGroup(group.id).length === 0) {
                <div class="p-4 text-center text-dash-text-dim text-sm">Keine Fixkosten in dieser Gruppe</div>
                }
            </div>
            }
        </div>
        }

        <!-- Excluded Fixed Costs Section -->
        @if (getExcludedFixedCosts().length > 0) {
        <div class="border-t-2 border-dash-border">
            <div class="p-3 md:p-4 bg-yellow-500/5 border-b border-dash-border">
                <div class="flex items-center gap-2 text-yellow-500">
                    <span class="material-symbols-sharp text-lg">visibility_off</span>
                    <span class="font-medium text-sm">Nicht in Summe</span>
                    <span class="text-xs">({{ excludedCount }})</span>
                    <span class="ml-auto text-xs">Summe: {{ formatCurrency(Math.abs(excludedTotal)) }}</span>
                </div>
            </div>
            <div cdkDropList [cdkDropListData]="getExcludedFixedCosts()" (cdkDropListDropped)="onDrop($event)"
                data-group-id="excluded" class="min-h-[20px]">
                @for (fixedCost of getExcludedFixedCosts(); track fixedCost.id) {
                <div class="opacity-60" cdkDrag [cdkDragData]="fixedCost"
                    [cdkDragDisabled]="expandedFixedCostId() === fixedCost.id">
                    <div class="fixed-cost-placeholder" *cdkDragPlaceholder></div>
                    <app-fixed-cost-item [fixedCost]="fixedCost" [accounts]="accounts" [categories]="categories"
                        [groups]="getSortedGroups()" [isExpanded]="expandedFixedCostId() === fixedCost.id"
                        [isEditing]="isEditingInline(fixedCost.id)" (expand)="toggleExpansion($event)"
                        (toggleEdit)="toggleInlineEdit($event)" (cancelEdit)="cancelInlineEdit($event)"
                        (save)="onSaveFixedCost(fixedCost.id, $event)" (delete)="onDeleteFixedCost($event)"
                        (book)="onCreateTransaction($event)">
                    </app-fixed-cost-item>
                </div>
                }
            </div>
        </div>
        }
        }
    </div>
</div>