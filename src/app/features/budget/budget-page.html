<div class="min-h-screen bg-dash-bg text-dash-text p-4 md:p-8 font-sans selection:bg-dash-accent selection:text-white">
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-12 grid-rows-[auto_1fr] gap-4 h-[calc(100vh-4rem)]">

        <!-- Header -->
        <header
            class="md:col-span-12 flex items-center justify-between bg-dash-card border border-dash-border p-4 rounded-sm">
            <div class="flex items-center gap-4">
                <!-- Apps Launcher -->
                <app-apps-launcher (openSettings)="toggleSettingsModal()"></app-apps-launcher>
                <h1 class="text-sm font-bold tracking-widest text-dash-text-dim uppercase">Budget</h1>
            </div>
            <div class="flex gap-4 text-xs font-mono text-dash-text-dim items-center">
                <div>TRANSACTIONS <span class="text-white">{{ transactions().length }}</span></div>
            </div>
        </header>

        <!-- Settings Modal -->
        <div *ngIf="showSettingsModal()" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="toggleSettingsModal()">
            </div>
            <div
                class="relative bg-dash-card border border-dash-border p-6 rounded-sm shadow-2xl w-full max-w-md flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-dash-text">Settings</h2>
                    <button (click)="toggleSettingsModal()"
                        class="text-dash-text-dim hover:text-white transition-colors">
                        <span class="material-symbols-sharp">close</span>
                    </button>
                </div>

                <div class="flex flex-col gap-3">
                    <button (click)="triggerImport()"
                        class="flex items-center justify-center gap-2 px-4 py-2 bg-dash-bg border border-dash-border hover:border-dash-accent text-dash-text rounded-sm transition-colors text-sm w-full">
                        <span class="material-symbols-sharp">upload</span>
                        CSV Importieren
                    </button>
                    <p class="text-xs text-dash-text-dim">
                        Format: ID, Amount, Date, Title, Empty, Account, Currency, Category
                    </p>
                </div>
            </div>
        </div>

        <!-- Sidebar / Left Column (Stats) -->
        <aside class="md:col-span-4 lg:col-span-3 flex flex-col gap-4">
            <!-- Balance Card -->
            <div class="bg-dash-card border border-dash-border p-6 rounded-sm">
                <h2 class="text-xs font-bold text-dash-text-dim uppercase mb-4 tracking-wider">Gesamtbilanz</h2>
                <div class="text-3xl font-bold text-dash-text mb-2">{{ formatCurrency(getStats().balance) }}</div>
                <div class="text-xs text-dash-text-dim">Diesen Monat</div>
            </div>

            <!-- Income Card -->
            <div class="bg-dash-card border border-dash-border p-6 rounded-sm">
                <h2 class="text-xs font-bold text-dash-text-dim uppercase mb-4 tracking-wider">Einnahmen</h2>
                <div class="text-2xl font-bold text-green-500">{{ formatCurrency(getStats().income) }}</div>
                <div class="text-xs text-dash-text-dim">Diesen Monat</div>
            </div>

            <!-- Expenses Card -->
            <div class="bg-dash-card border border-dash-border p-6 rounded-sm">
                <h2 class="text-xs font-bold text-dash-text-dim uppercase mb-4 tracking-wider">Ausgaben</h2>
                <div class="text-2xl font-bold text-red-500">{{ formatCurrency(getStats().expenses) }}</div>
                <div class="text-xs text-dash-text-dim">Diesen Monat</div>
            </div>

            <!-- Accounts List -->
            <div class="bg-dash-card border border-dash-border p-6 rounded-sm flex-1">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-dash-text-dim uppercase tracking-wider">Konten</h2>
                    <button *ngIf="selectedAccountId()" (click)="selectAccount(null)"
                        class="text-xs text-dash-accent hover:underline">
                        Alle anzeigen
                    </button>
                </div>
                <div class="flex flex-col gap-2">
                    <div *ngFor="let account of accounts()" (click)="selectAccount(account.id)"
                        class="flex justify-between items-center text-sm p-2 rounded-sm cursor-pointer transition-colors border border-transparent"
                        [class.bg-dash-card-hover]="selectedAccountId() === account.id"
                        [class.border-dash-accent]="selectedAccountId() === account.id"
                        [class.hover:bg-dash-bg]="selectedAccountId() !== account.id">
                        <span class="text-dash-text font-medium">{{ account.name }}</span>
                        <span class="font-mono" [class.text-red-500]="account.balance < 0"
                            [class.text-green-500]="account.balance > 0">{{ formatCurrency(account.balance) }}</span>
                    </div>
                    <div *ngIf="accounts().length === 0" class="text-dash-text-dim text-xs italic">
                        Keine Konten erstellt.
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="md:col-span-8 lg:col-span-9 flex flex-col gap-4 h-full overflow-hidden">
            <!-- Actions Bar -->
            <div
                class="bg-dash-card border border-dash-border p-4 rounded-sm flex flex-col md:flex-row items-center gap-4">
                <!-- Search -->
                <div class="relative w-full md:w-64">
                    <span
                        class="material-symbols-sharp absolute left-3 top-1/2 -translate-y-1/2 text-dash-text-dim text-lg">search</span>
                    <input type="text" placeholder="Suchen..." (input)="onSearch($event)"
                        class="w-full bg-dash-bg border border-dash-border text-dash-text pl-10 pr-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent text-sm">
                </div>

                <div class="flex-1 flex gap-4 w-full justify-end">
                    <button (click)="toggleTransactionModal()"
                        class="bg-dash-accent hover:bg-dash-accent-hover text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors flex items-center justify-center gap-2 flex-1 md:flex-none">
                        <span class="material-symbols-sharp text-lg">add</span>
                        <span class="hidden sm:inline">Transaktion</span>
                    </button>
                    <button (click)="toggleAccountModal()"
                        class="bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border flex items-center justify-center gap-2 flex-1 md:flex-none">
                        <span class="material-symbols-sharp text-lg">account_balance</span>
                        <span class="hidden sm:inline">Konto</span>
                    </button>
                    <button (click)="toggleCategoryModal()"
                        class="bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border flex items-center justify-center gap-2 flex-1 md:flex-none">
                        <span class="material-symbols-sharp text-lg">category</span>
                        <span class="hidden sm:inline">Kategorie</span>
                    </button>
                </div>
            </div>

            <!-- Transactions List -->
            <div
                class="bg-dash-card border border-dash-border p-0 rounded-sm flex-1 overflow-hidden flex flex-col relative">

                <!-- List Header -->
                <div
                    class="grid grid-cols-12 gap-4 p-4 border-b border-dash-border text-xs font-bold text-dash-text-dim uppercase tracking-wider">
                    <div class="col-span-2">Datum</div>
                    <div class="col-span-4">Titel</div>
                    <div class="col-span-2">Konto</div>
                    <div class="col-span-2">Kategorie</div>
                    <div class="col-span-2 text-right">Betrag</div>
                </div>

                <div class="h-full overflow-y-auto">
                    <div class="divide-y divide-dash-border">
                        @if (getSortedTransactions().length === 0) {
                        <div class="text-center py-12 text-dash-text-dim">
                            <span class="material-symbols-sharp text-4xl opacity-50 block mb-2">receipt_long</span>
                            <p>Keine Transaktionen vorhanden</p>
                        </div>
                        } @else {
                        @for (transaction of getSortedTransactions(); track transaction.id) {
                        <div class="flex flex-col border-b border-dash-border last:border-0">
                            <div (click)="toggleExpansion(transaction.id)"
                                class="grid grid-cols-12 gap-4 p-4 hover:bg-dash-card-hover transition-colors items-center text-sm cursor-pointer"
                                [class.bg-dash-card-hover]="expandedTransactionId() === transaction.id">
                                <!-- Date -->
                                <div class="col-span-2 text-dash-text-dim font-mono text-xs">
                                    {{ formatDate(transaction.date) }}
                                </div>

                                <!-- Title -->
                                <div class="col-span-4 font-medium text-dash-text truncate"
                                    title="{{ transaction.description }}">
                                    {{ transaction.description }}
                                </div>

                                <!-- Account -->
                                <div class="col-span-2 text-dash-text-dim truncate">
                                    {{ getAccountById(transaction.account)?.name || 'Unbekannt' }}
                                    <span *ngIf="transaction.type === 'transfer'" class="text-xs text-dash-accent">
                                        → {{ getAccountById(transaction.toAccount!)?.name }}
                                    </span>
                                </div>

                                <!-- Category -->
                                <div class="col-span-2 flex items-center gap-2 text-dash-text-dim truncate">
                                    <span class="material-symbols-sharp text-base">{{
                                        getCategoryById(transaction.category)?.icon || 'category' }}</span>
                                    <span class="truncate">{{ getCategoryById(transaction.category)?.name || 'Unbekannt'
                                        }}</span>
                                </div>

                                <!-- Amount -->
                                <div class="col-span-2 text-right font-mono font-bold"
                                    [class.text-green-500]="transaction.type === 'income'"
                                    [class.text-red-500]="transaction.type === 'expense'"
                                    [class.text-blue-400]="transaction.type === 'transfer'">
                                    <span *ngIf="transaction.type === 'transfer'"
                                        class="material-symbols-sharp text-base align-middle mr-1">sync_alt</span>
                                    {{ transaction.type === 'income' ? '+' : (transaction.type === 'expense' ? '-' : '')
                                    }}{{ formatCurrency(transaction.amount) }}
                                </div>
                            </div>

                            <!-- Expanded Actions -->
                            <div *ngIf="expandedTransactionId() === transaction.id"
                                class="px-4 pb-4 flex justify-end gap-2 bg-dash-card-hover">
                                <button (click)="openEditModal(transaction); $event.stopPropagation()"
                                    class="px-3 py-1 bg-dash-bg hover:bg-dash-border text-dash-text text-xs rounded-sm border border-dash-border transition-colors flex items-center gap-1">
                                    <span class="material-symbols-sharp text-sm">edit</span>
                                    Bearbeiten
                                </button>
                                <button (click)="deleteTransaction(transaction.id); $event.stopPropagation()"
                                    class="px-3 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 text-xs rounded-sm border border-red-500/30 transition-colors flex items-center gap-1">
                                    <span class="material-symbols-sharp text-sm">delete</span>
                                    Löschen
                                </button>
                            </div>
                        </div>
                        }
                        }
                    </div>
                </div>
            </div>
        </main>

    </div>
</div>

<!-- Transaction Modal -->
@if (showTransactionModal()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        (click)="toggleTransactionModal(); editingTransaction.set(null)"></div>
    <div class="relative bg-dash-card border border-dash-border p-6 rounded-sm shadow-2xl w-full max-w-md">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-dash-text">{{ editingTransaction() ? 'Transaktion bearbeiten' : 'Neue
                Transaktion' }}</h2>
            <button (click)="toggleTransactionModal(); editingTransaction.set(null)"
                class="text-dash-text-dim hover:text-white transition-colors">
                <span class="material-symbols-sharp">close</span>
            </button>
        </div>
        <form (submit)="onTransactionSubmit($event)" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Typ</label>
                <div class="flex gap-2">
                    <button type="button" (click)="setTransactionType('expense')"
                        [class]="currentTransactionType() === 'expense' ? 'flex-1 bg-red-500/20 text-red-500 border border-red-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border'">
                        Ausgabe
                    </button>
                    <button type="button" (click)="setTransactionType('income')"
                        [class]="currentTransactionType() === 'income' ? 'flex-1 bg-green-500/20 text-green-500 border border-green-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border'">
                        Einnahme
                    </button>
                    <button type="button" (click)="setTransactionType('transfer')"
                        [class]="currentTransactionType() === 'transfer' ? 'flex-1 bg-blue-500/20 text-blue-500 border border-blue-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border'">
                        Transfer
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Betrag
                    (€)</label>
                <input type="number" name="amount" step="0.01" required [ngModel]="editingTransaction()?.amount"
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="0,00">
            </div>
            <div>
                <label
                    class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Beschreibung</label>
                <input type="text" name="description" required [ngModel]="editingTransaction()?.description"
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="z.B. Einkauf bei Supermarkt">
            </div>
            <div>
                <label
                    class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Kategorie</label>
                <select name="category" required [ngModel]="editingTransaction()?.category"
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent">
                    <option value="">Kategorie wählen</option>
                    @for (category of categories(); track category.id) {
                    <option [value]="category.id">{{ category.name }}</option>
                    }
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">
                        {{ currentTransactionType() === 'transfer' ? 'Von Konto' : 'Konto' }}
                    </label>
                    <select name="account" required [ngModel]="editingTransaction()?.account"
                        class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent">
                        <option value="">Wählen</option>
                        @for (account of accounts(); track account.id) {
                        <option [value]="account.id">{{ account.name }}</option>
                        }
                    </select>
                </div>

                <div *ngIf="currentTransactionType() === 'transfer'">
                    <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Nach
                        Konto</label>
                    <select name="toAccount" required [ngModel]="editingTransaction()?.toAccount"
                        class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent">
                        <option value="">Wählen</option>
                        @for (account of accounts(); track account.id) {
                        <option [value]="account.id">{{ account.name }}</option>
                        }
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Datum</label>
                <input type="date" id="transactionDate" name="date" required [value]="getTodayDateString()"
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent">
            </div>
            <div class="flex gap-2 pt-4">
                <button type="button" (click)="toggleTransactionModal(); editingTransaction.set(null)"
                    class="flex-1 bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border">
                    Abbrechen
                </button>
                <button type="submit"
                    class="flex-1 bg-dash-accent hover:bg-dash-accent-hover text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                    {{ editingTransaction() ? 'Speichern' : 'Hinzufügen' }}
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- Account Modal -->
@if (showAccountModal()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="toggleAccountModal()"></div>
    <div class="relative bg-dash-card border border-dash-border p-6 rounded-sm shadow-2xl w-full max-w-md">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-dash-text">Neues Konto</h2>
            <button (click)="toggleAccountModal()" class="text-dash-text-dim hover:text-white transition-colors">
                <span class="material-symbols-sharp">close</span>
            </button>
        </div>
        <form (submit)="addAccount($event)" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Name</label>
                <input type="text" name="accountName" required
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="z.B. Girokonto">
            </div>
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Startguthaben
                    (€)</label>
                <input type="number" name="accountBalance" step="0.01" required
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="0,00">
            </div>
            <div class="flex gap-2 pt-4">
                <button type="button" (click)="toggleAccountModal()"
                    class="flex-1 bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border">
                    Abbrechen
                </button>
                <button type="submit"
                    class="flex-1 bg-dash-accent hover:bg-dash-accent-hover text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                    Speichern
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- Category Modal -->
@if (showCategoryModal()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="toggleCategoryModal()"></div>
    <div class="relative bg-dash-card border border-dash-border p-6 rounded-sm shadow-2xl w-full max-w-md">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-dash-text">Neue Kategorie</h2>
            <button (click)="toggleCategoryModal()" class="text-dash-text-dim hover:text-white transition-colors">
                <span class="material-symbols-sharp">close</span>
            </button>
        </div>
        <form (submit)="addCategory($event)" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Name</label>
                <input type="text" name="categoryName" required
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="z.B. Kleidung">
            </div>
            <div>
                <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Icon (Google
                    Material Symbol)</label>
                <input type="text" name="categoryIcon" required
                    class="w-full bg-dash-bg border border-dash-border text-dash-text px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent"
                    placeholder="z.B. checkroom">
                <p class="text-xs text-dash-text-dim mt-1">Siehe <a href="https://fonts.google.com/icons"
                        target="_blank" class="text-dash-accent hover:underline">Google Fonts Icons</a></p>
            </div>
            <div class="flex gap-2 pt-4">
                <button type="button" (click)="toggleCategoryModal()"
                    class="flex-1 bg-dash-bg hover:bg-dash-card-hover text-dash-text-dim hover:text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border">
                    Abbrechen
                </button>
                <button type="submit"
                    class="flex-1 bg-dash-accent hover:bg-dash-accent-hover text-white px-4 py-2 rounded-sm text-sm font-medium transition-colors">
                    Speichern
                </button>
            </div>
        </form>
    </div>
</div>
}