<div class="min-h-screen text-dash-text p-4 md:p-8 font-sans selection:bg-dash-accent selection:text-white pb-16">
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-4">

        <!-- Header -->
        <header
            class="md:col-span-12 flex items-center justify-between gradient-header p-3 md:p-4 rounded-sm sticky top-0 z-50 shadow-lg">
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Apps Launcher -->
                <app-apps-launcher (openSettings)="modalHandlers.toggleSettingsModal()"></app-apps-launcher>
                <h1 class="text-xs md:text-sm font-bold tracking-widest text-dash-text-dim uppercase">Budget</h1>
            </div>
            <div class="flex gap-2 text-xs font-mono text-dash-text-dim items-center">
                <!-- View Toggle Switch -->
                <div class="flex items-center gap-1 md:gap-2 bg-dash-bg rounded-sm p-1 border border-dash-border">
                    <button (click)="toggleViewMode('transactions')"
                        [class]="viewMode() === 'transactions' ? 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors bg-dash-accent text-white' : 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors text-dash-text-dim hover:text-white'">
                        <span class="material-symbols-sharp text-sm align-middle md:mr-1">receipt_long</span>
                        <span class="hidden md:inline">Transaktionen</span>
                    </button>
                    <button (click)="toggleViewMode('statistics')"
                        [class]="viewMode() === 'statistics' ? 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors bg-dash-accent text-white' : 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors text-dash-text-dim hover:text-white'">
                        <span class="material-symbols-sharp text-sm align-middle md:mr-1">analytics</span>
                        <span class="hidden md:inline">Statistik</span>
                    </button>
                    <button (click)="toggleViewMode('fixedcosts')"
                        [class]="viewMode() === 'fixedcosts' ? 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors bg-dash-accent text-white' : 'px-2 md:px-3 py-1.5 rounded-sm text-xs font-medium transition-colors text-dash-text-dim hover:text-white'">
                        <span class="material-symbols-sharp text-sm align-middle md:mr-1">bookmark</span>
                        <span class="hidden md:inline">Fixkosten</span>
                    </button>
                </div>
                <div class="hidden sm:block">TRANSACTIONS <span class="text-white">{{ stateService.transactions().length
                        }}</span>
                </div>
                <!-- Local Settings Button -->
                <button (click)="modalHandlers.toggleSettingsModal()"
                    class="w-10 h-10 bg-dash-bg rounded-sm flex items-center justify-center hover:bg-dash-accent cursor-pointer text-dash-text-dim hover:text-white transition-all"
                    title="Budget Settings">
                    <span class="material-symbols-sharp text-xl">settings</span>
                </button>
                <!-- Right Sidebar Toggle -->
                <button (click)="toggleRightSidebar()"
                    class="w-10 h-10 bg-dash-bg rounded-sm flex items-center justify-center hover:bg-dash-accent cursor-pointer text-dash-text-dim hover:text-white transition-all"
                    title="Rechte Sidebar">
                    <span class="material-symbols-sharp text-xl">menu_open</span>
                </button>
            </div>
        </header>

        <!-- Settings Modal -->
        @if (showSettingsModal()) {
        <app-settings-modal [accounts]="stateService.accounts()" [categories]="stateService.categories()"
            [groups]="stateService.getFixedCostGroupsSortedByOrder()" (close)="modalHandlers.toggleSettingsModal()"
            (importData)="importExportHandlers.triggerImport()" (exportData)="importExportHandlers.triggerExport()"
            (deleteAllTransactions)="entityHandlers.deleteAllTransactions()"
            (addAccount)="modalHandlers.toggleAccountModal()" (editAccount)="modalHandlers.openEditAccountModal($event)"
            (deleteAccount)="entityHandlers.deleteAccount($event)"
            (addCategory)="editingCategory.set(null); modalHandlers.toggleCategoryModal()"
            (editCategory)="modalHandlers.openEditCategoryModal($event)"
            (deleteCategory)="entityHandlers.deleteCategory($event)"
            (deleteAllCategories)="entityHandlers.deleteAllCategories()"
            (deleteSelectedCategories)="entityHandlers.deleteSelectedCategories($event)"
            (loadDefaultCategories)="entityHandlers.loadDefaultCategories()"
            (addGroup)="modalHandlers.toggleFixedCostGroupModal()"
            (editGroup)="modalHandlers.openEditFixedCostGroupModal($event)"
            (deleteGroup)="entityHandlers.deleteFixedCostGroup($event)"
            (deleteAllGroups)="entityHandlers.deleteAllFixedCostGroups()"
            (deleteSelectedGroups)="entityHandlers.deleteSelectedFixedCostGroups($event)"
            (reorderGroups)="entityHandlers.reorderFixedCostGroups($event)">
        </app-settings-modal>
        }

        <!-- Main Content Area -->
        <main class="md:col-span-8 lg:col-span-9 flex flex-col gap-4 order-2 md:order-1">

            <!-- TRANSACTIONS VIEW -->
            @if (viewMode() === 'transactions') {
            <app-transactions-view [transactions]="stateService.getSortedTransactions()"
                [accounts]="stateService.accounts()" [categories]="stateService.categories()"
                [searchQuery]="stateService.searchQuery()" [newlyCreatedId]="newlyCreatedTransactionId()"
                (addTransaction)="modalHandlers.openNewTransactionModal()"
                (editTransaction)="modalHandlers.openEditTransactionModal($event)"
                (deleteTransaction)="entityHandlers.deleteTransaction($event)"
                (copyToFixedCost)="entityHandlers.copyTransactionToFixedCost($event)"
                (search)="stateService.onSearch($event)">
            </app-transactions-view>
            }

            <!-- STATISTICS VIEW -->
            @if (viewMode() === 'statistics') {
            <app-statistics-view [stats]="statsService.getStats()" [categoryStats]="statsService.getCategoryStats()"
                [incomeCategoryStats]="statsService.getIncomeCategoryStats()"
                [dailyTrend]="statsService.getDailyTrend()" [topExpenses]="statsService.getTopExpenses()"
                [selectedMonthName]="statsService.getSelectedMonthName()"
                [selectedAccountName]="stateService.selectedAccountId() ? (stateService.getAccountById(stateService.selectedAccountId()!)?.name ?? null) : null"
                [transactionCount]="stateService.getSortedTransactions().length"
                [incomeTransactionCount]="statsService.getIncomeTransactionCount()"
                [expenseTransactionCount]="statsService.getExpenseTransactionCount()"
                [averageDailyExpense]="statsService.getAverageDailyExpense()"
                [averageDailyIncome]="statsService.getAverageDailyIncome()"
                [largestExpense]="statsService.getLargestExpense()" [largestIncome]="statsService.getLargestIncome()"
                [pieChartGradient]="statsService.getPieChartGradient()"
                [incomePieChartGradient]="statsService.getIncomePieChartGradient()"
                [trendPoints]="statsService.getTrendPoints()" [trendAreaPoints]="statsService.getTrendAreaPoints()"
                [trendMaxValue]="statsService.getTrendMaxValue()" [trendMinValue]="statsService.getTrendMinValue()"
                [zeroLineY]="statsService.getZeroLineY()" [daysInSelectedMonth]="statsService.getDaysInSelectedMonth()">
            </app-statistics-view>
            }

            <!-- FIXKOSTEN VIEW -->
            @if (viewMode() === 'fixedcosts') {
            <app-fixed-costs-view [fixedCosts]="stateService.getFixedCostsSortedByOrder()"
                [accounts]="stateService.accounts()" [categories]="stateService.categories()"
                [groups]="stateService.getFixedCostGroupsSortedByOrder()"
                [fixedIncomeTotal]="stateService.getFixedIncomeTotal()"
                [fixedCostsTotal]="stateService.getFixedCostsTotal()"
                [fixedTransferTotal]="stateService.getFixedTransferTotal()"
                [fixedIncomeCount]="stateService.getFixedIncomeCount()"
                [fixedExpenseCount]="stateService.getFixedExpenseCount()"
                [fixedTransferCount]="stateService.getFixedTransferCount()"
                [excludedTotal]="stateService.getExcludedFixedCostsTotal()"
                [excludedCount]="stateService.getExcludedFixedCostsCount()"
                (addFixedCost)="modalHandlers.openNewFixedCostModal()"
                (editFixedCost)="modalHandlers.openEditFixedCostModalUnified($event)"
                (deleteFixedCost)="entityHandlers.deleteFixedCost($event)"
                (createTransaction)="modalHandlers.openBookFixedCostModal($event)"
                (addGroup)="modalHandlers.toggleFixedCostGroupModal()"
                (editGroup)="modalHandlers.openEditFixedCostGroupModal($event)"
                (deleteGroup)="entityHandlers.deleteFixedCostGroup($event)"
                (reorderFixedCosts)="entityHandlers.reorderFixedCosts($event)">
            </app-fixed-costs-view>
            }

        </main>

        <!-- Sidebar -->
        <aside class="md:col-span-4 lg:col-span-3 flex flex-col gap-4 order-1 md:order-2">
            <app-budget-sidebar [stats]="statsService.getStats()" [accounts]="stateService.accounts()"
                [transactions]="stateService.transactions()" [selectedAccountId]="stateService.selectedAccountId()"
                [totalBalance]="stateService.getTotalBalance()" (selectAccount)="entityHandlers.selectAccount($event)"
                (monthChange)="stateService.onMonthChange($event)">
            </app-budget-sidebar>
        </aside>

        <!-- Transaction Modal -->
        @if (showTransactionModal()) {
        <app-transaction-modal [editingTransaction]="editingTransaction()"
            [prefillFromFixedCost]="prefillFromFixedCost()" [accounts]="stateService.accounts()"
            [categories]="stateService.categories()"
            (close)="modalHandlers.toggleTransactionModal(); editingTransaction.set(null); prefillFromFixedCost.set(null)"
            (transactionSubmit)="onTransactionModalSubmit($event)">
        </app-transaction-modal>
        }

        <!-- Account Modal -->
        @if (showAccountModal()) {
        <app-account-modal [editingAccount]="editingAccount()"
            (close)="modalHandlers.toggleAccountModal(); editingAccount.set(null)"
            (submit)="modalHandlers.onAccountModalSubmit($event)">
        </app-account-modal>
        }

        <!-- Category Modal -->
        @if (showCategoryModal()) {
        <app-category-modal [editingCategory]="editingCategory()"
            (close)="modalHandlers.toggleCategoryModal(); editingCategory.set(null)"
            (submit)="modalHandlers.onCategoryModalSubmit($event)">
        </app-category-modal>
        }

        <!-- Fixed Cost Group Modal -->
        @if (showFixedCostGroupModal()) {
        <app-fixed-cost-group-modal [editingGroup]="editingFixedCostGroup()"
            (close)="modalHandlers.toggleFixedCostGroupModal()"
            (groupSubmit)="modalHandlers.onFixedCostGroupModalSubmit($event)">
        </app-fixed-cost-group-modal>
        }

        <!-- Fixed Cost Modal -->
        @if (showFixedCostModal()) {
        <app-fixed-cost-modal [editingFixedCost]="editingFixedCost()" [accounts]="stateService.accounts()"
            [categories]="stateService.categories()" [groups]="stateService.getFixedCostGroupsSortedByOrder()"
            (close)="modalHandlers.toggleFixedCostModal()" (submit)="onFixedCostSubmit($event)">
        </app-fixed-cost-modal>
        }

        <!-- Toast Notification -->
        @if (toastMessage()) {
        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-slide-in-up">
            <div class="bg-gradient-to-r from-green-600 to-emerald-500 p-5 rounded-lg shadow-2xl border-2 border-green-400/50 flex items-center gap-4 max-w-lg"
                style="box-shadow: 0 0 30px rgba(34, 197, 94, 0.4), 0 10px 40px rgba(0, 0, 0, 0.3);">
                <div
                    class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0 animate-pulse">
                    <span class="material-symbols-sharp text-white text-3xl">check_circle</span>
                </div>
                <div class="flex-1 text-base font-semibold text-white">{{ toastMessage() }}</div>
                <button (click)="hideToast()"
                    class="text-white/70 hover:text-white transition-colors flex-shrink-0 hover:scale-110">
                    <span class="material-symbols-sharp text-xl">close</span>
                </button>
            </div>
        </div>
        }
    </div>
</div>