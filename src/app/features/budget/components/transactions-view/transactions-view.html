<!-- Transaction List Header with Frame -->
<div class="gradient-card p-3 md:p-4 rounded-sm">
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 md:gap-4">
        <!-- Title (Left) - Hidden on mobile, shown in button -->
        <h2 class="hidden sm:block text-lg font-bold text-dash-text whitespace-nowrap">Transaktionen</h2>

        <!-- Search Field (Center) -->
        <div class="flex-1 w-full sm:max-w-md order-2 sm:order-none">
            <input type="text" (input)="onSearch($event)" [value]="searchQuery" placeholder="Transaktion suchen..."
                class="w-full bg-dash-bg border border-dash-border text-dash-text px-3 md:px-4 py-2 rounded-sm focus:outline-none focus:border-dash-accent text-sm">
        </div>

        <!-- Button (Right) -->
        <button (click)="addTransaction.emit()"
            class="gradient-btn text-white px-3 md:px-4 py-2 rounded-sm text-sm font-medium flex items-center justify-center gap-2 whitespace-nowrap order-1 sm:order-none">
            <span class="material-symbols-sharp text-lg">add</span>
            <span class="sm:hidden">Neue Transaktion</span>
            <span class="hidden sm:inline">Neue Transaktion</span>
        </button>
    </div>
</div>

<!-- Transaction List Container -->
<div class="gradient-card rounded-sm">
    @if (transactions.length === 0) {
    <div class="p-8 text-center">
        <span class="material-symbols-sharp text-4xl text-dash-text-dim mb-4 block">receipt_long</span>
        <p class="text-dash-text-dim text-sm">Keine Transaktionen für diesen Monat.</p>
        <p class="text-dash-text-dim text-xs mt-2">Klicken Sie auf "Neue Transaktion" um eine hinzuzufügen.</p>
    </div>
    }
    @for (transaction of transactions; track transaction.id; let last = $last) {
    <div class="p-3 md:p-4 cursor-pointer hover:bg-dash-card-hover transition-colors"
        (click)="toggleExpansion(transaction.id)" [class.border-b]="!last" [class.border-dash-border]="!last">
        <!-- Transaction Row - Mobile Layout -->
        <div class="flex flex-col gap-2 md:hidden">
            <!-- Top row: Description and Amount -->
            <div class="flex justify-between items-start gap-2">
                <div class="font-medium text-dash-text truncate flex-1" title="{{ transaction.description }}">
                    {{ transaction.description }}
                </div>
                <div class="font-mono font-bold text-sm whitespace-nowrap"
                    [class.text-green-500]="transaction.type === 'income'"
                    [class.text-red-500]="transaction.type === 'expense'"
                    [class.text-purple-400]="transaction.type === 'transfer'">
                    <span *ngIf="transaction.type === 'transfer'"
                        class="material-symbols-sharp text-sm align-middle mr-1">sync_alt</span>
                    {{ transaction.type === 'income' ? '+' : (transaction.type === 'expense' ? '-' : '')
                    }}{{ formatCurrency(transaction.amount) }}
                </div>
            </div>
            <!-- Bottom row: Date, Account, Category -->
            <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-dash-text-dim">
                <span class="font-mono">{{ formatDate(transaction.date) }}</span>
                <span class="truncate">{{ getAccountById(transaction.account)?.name || 'Unbekannt' }}
                    <span *ngIf="transaction.type === 'transfer'" class="text-dash-accent">
                        → {{ getAccountById(transaction.toAccount!)?.name }}
                    </span>
                </span>
                <span class="truncate">{{ getCategoryFullName(transaction.category) }}</span>
            </div>
        </div>

        <!-- Transaction Row - Desktop Layout -->
        <div class="hidden md:grid grid-cols-12 gap-4 items-center">
            <!-- Date -->
            <div class="col-span-2 text-dash-text-dim font-mono text-xs">
                {{ formatDate(transaction.date) }}
            </div>

            <!-- Title -->
            <div class="col-span-4 font-medium text-dash-text truncate" title="{{ transaction.description }}">
                {{ transaction.description }}
            </div>

            <!-- Account -->
            <div class="col-span-2 text-dash-text-dim truncate">
                {{ getAccountById(transaction.account)?.name || 'Unbekannt' }}
                <span *ngIf="transaction.type === 'transfer'" class="text-xs text-dash-accent">
                    → {{ getAccountById(transaction.toAccount!)?.name }}
                </span>
            </div>

            <!-- Category -->
            <div class="col-span-2 flex items-center gap-2 text-dash-text-dim truncate">
                <span class="truncate">{{ getCategoryFullName(transaction.category) }}</span>
            </div>

            <!-- Amount -->
            <div class="col-span-2 text-right font-mono font-bold"
                [class.text-green-500]="transaction.type === 'income'"
                [class.text-red-500]="transaction.type === 'expense'"
                [class.text-purple-400]="transaction.type === 'transfer'">
                <span *ngIf="transaction.type === 'transfer'"
                    class="material-symbols-sharp text-base align-middle mr-1">sync_alt</span>
                {{ transaction.type === 'income' ? '+' : (transaction.type === 'expense'
                ? '-' : '')
                }}{{ formatCurrency(transaction.amount) }}
            </div>
        </div>

        <!-- Expanded Edit Form -->
        <div *ngIf="expandedTransactionId() === transaction.id" class="mt-4 pt-4 border-t border-dash-border"
            (click)="$event.stopPropagation()">
            <form (submit)="onInlineTransactionEdit($event, transaction.id)" class="space-y-4">

                <!-- Type Selection -->
                <div>
                    <label class="block text-xs font-bold text-dash-text-dim uppercase mb-2 tracking-wider">Typ</label>
                    <div class="flex gap-2">
                        <button type="button" (click)="setInlineTransactionType(transaction.id, 'expense')"
                            [disabled]="!isEditingInline(transaction.id)"
                            [class]="getInlineTransactionType(transaction.id) === 'expense' ? 'flex-1 bg-red-500/20 text-red-500 border border-red-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors disabled:opacity-50' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border disabled:opacity-50'">
                            Ausgabe
                        </button>
                        <button type="button" (click)="setInlineTransactionType(transaction.id, 'income')"
                            [disabled]="!isEditingInline(transaction.id)"
                            [class]="getInlineTransactionType(transaction.id) === 'income' ? 'flex-1 bg-green-500/20 text-green-500 border border-green-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors disabled:opacity-50' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border disabled:opacity-50'">
                            Einnahme
                        </button>
                        <button type="button" (click)="setInlineTransactionType(transaction.id, 'transfer')"
                            [disabled]="!isEditingInline(transaction.id)"
                            [class]="getInlineTransactionType(transaction.id) === 'transfer' ? 'flex-1 bg-purple-500/20 text-purple-500 border border-purple-500 px-4 py-2 rounded-sm text-sm font-medium transition-colors disabled:opacity-50' : 'flex-1 bg-dash-bg text-dash-text-dim px-4 py-2 rounded-sm text-sm font-medium transition-colors border border-dash-border disabled:opacity-50'">
                            Transfer
                        </button>
                    </div>
                </div>

                <!-- All fields in compact responsive grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <div>
                        <label
                            class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">Betrag</label>
                        <input type="number" name="amount" step="0.01" required [value]="transaction.amount"
                            [disabled]="!isEditingInline(transaction.id)"
                            class="w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed"
                            placeholder="0,00">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">Datum</label>
                        <input type="date" name="date" required [value]="transaction.date"
                            [disabled]="!isEditingInline(transaction.id)"
                            class="w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">Kategorie</label>
                        <select name="category" [required]="!isCategoryDisabledForTransaction(transaction.id)"
                            [disabled]="!isEditingInline(transaction.id) || isCategoryDisabledForTransaction(transaction.id)"
                            [class]="isCategoryDisabledForTransaction(transaction.id) 
                                ? 'w-full bg-dash-bg/50 border border-dash-border/50 text-dash-text-dim px-2 py-1.5 rounded-sm text-sm cursor-not-allowed opacity-50' 
                                : 'w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed'">
                            @if (isCategoryDisabledForTransaction(transaction.id)) {
                            <option value="">Nicht verfügbar bei Transfer</option>
                            } @else if (getFilteredCategoriesForTransaction(transaction.id).length === 0) {
                            <option value="">Keine passenden Kategorien</option>
                            } @else {
                            <option value="">Wählen</option>
                            @for (category of getFilteredCategoriesForTransaction(transaction.id); track category.id) {
                            <option [value]="category.id" [selected]="category.id === transaction.category">{{
                                category.name }}</option>
                            }
                            }
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">
                            {{ getInlineTransactionType(transaction.id) === 'transfer' ? 'Von Konto' : 'Konto' }}
                        </label>
                        <select name="account" required [disabled]="!isEditingInline(transaction.id)"
                            class="w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="">Wählen</option>
                            @for (account of accounts; track account.id) {
                            <option [value]="account.id" [selected]="account.id === transaction.account">{{
                                account.name }}</option>
                            }
                        </select>
                    </div>
                    <div *ngIf="getInlineTransactionType(transaction.id) === 'transfer'">
                        <label class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">Nach
                            Konto</label>
                        <select name="toAccount" [required]="getInlineTransactionType(transaction.id) === 'transfer'"
                            [disabled]="!isEditingInline(transaction.id)"
                            class="w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="">Wählen</option>
                            @for (account of accounts; track account.id) {
                            <option [value]="account.id" [selected]="account.id === transaction.toAccount">
                                {{ account.name }}</option>
                            }
                        </select>
                    </div>
                    <div class="col-span-2 md:col-span-3 lg:col-span-2"
                        [class.lg:col-span-1]="getInlineTransactionType(transaction.id) === 'transfer'">
                        <label
                            class="block text-xs font-bold text-dash-text-dim uppercase mb-1 tracking-wider">Beschreibung</label>
                        <input type="text" name="description" required [value]="transaction.description"
                            [disabled]="!isEditingInline(transaction.id)"
                            class="w-full bg-dash-bg border border-dash-border text-dash-text px-2 py-1.5 rounded-sm text-sm focus:outline-none focus:border-dash-accent disabled:opacity-50 disabled:cursor-not-allowed"
                            placeholder="z.B. Einkauf bei Supermarkt">
                    </div>
                </div>

                <!-- Hidden toAccount field for non-transfer (to keep form submission working) -->
                <input type="hidden" name="toAccount" value=""
                    *ngIf="getInlineTransactionType(transaction.id) !== 'transfer'">

                <!-- Action Buttons -->
                <div class="flex flex-wrap justify-end gap-2 pt-2">
                    <button type="button" *ngIf="!isEditingInline(transaction.id)"
                        (click)="toggleInlineEdit(transaction.id); $event.stopPropagation()"
                        class="px-2 sm:px-3 py-1 bg-dash-bg hover:bg-dash-border text-dash-text text-xs rounded-sm border border-dash-border transition-colors flex items-center gap-1">
                        <span class="material-symbols-sharp text-sm">edit</span>
                        <span class="hidden sm:inline">Bearbeiten</span>
                    </button>

                    <button type="button" *ngIf="isEditingInline(transaction.id)"
                        (click)="cancelInlineEdit(transaction.id); $event.stopPropagation()"
                        class="px-2 sm:px-3 py-1 bg-dash-bg hover:bg-dash-border text-dash-text-dim hover:text-white text-xs rounded-sm border border-dash-border transition-colors flex items-center gap-1">
                        <span class="material-symbols-sharp text-sm">close</span>
                        <span class="hidden sm:inline">Abbrechen</span>
                    </button>

                    <button type="submit" *ngIf="isEditingInline(transaction.id)"
                        class="px-2 sm:px-3 py-1 bg-dash-accent hover:bg-dash-accent-hover text-white text-xs rounded-sm transition-colors flex items-center gap-1">
                        <span class="material-symbols-sharp text-sm">save</span>
                        <span class="hidden sm:inline">Speichern</span>
                    </button>

                    <button type="button" (click)="onDeleteTransaction(transaction.id); $event.stopPropagation()"
                        class="px-2 sm:px-3 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 text-xs rounded-sm border border-red-500/30 transition-colors flex items-center gap-1">
                        <span class="material-symbols-sharp text-sm">delete</span>
                        <span class="hidden sm:inline">Löschen</span>
                    </button>

                    <button type="button" (click)="onCopyToFixedCost(transaction); $event.stopPropagation()"
                        class="px-2 sm:px-3 py-1 bg-dash-accent/10 hover:bg-dash-accent/20 text-dash-accent text-xs rounded-sm border border-dash-accent/30 transition-colors flex items-center gap-1"
                        title="Als Fixkosten speichern">
                        <span class="material-symbols-sharp text-sm">bookmark_add</span>
                        <span class="hidden sm:inline">Als Fixkosten</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    }
</div>