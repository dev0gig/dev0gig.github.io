import{b as h,d as b,u as m}from"./chunk-3T5KDFEF.js";import{a as d,b as u}from"./chunk-LS4SCMUJ.js";var w=class l{progressSubject=new b({status:"idle",message:"",progress:0});progress$=this.progressSubject.asObservable();updateProgress(e,t,a){this.progressSubject.next({status:e,message:t,progress:a})}readFileAsArrayBuffer(e){return new h(t=>{let a=new FileReader;a.onload=()=>{t.next(a.result),t.complete()},a.onerror=()=>t.error(a.error),a.readAsArrayBuffer(e)})}async extractArchive(e){let t=(await import("./chunk-7DPAS54S.js")).default;this.updateProgress("extracting",`Entpacke ${e.name}...`,0);let a=await e.arrayBuffer(),r=await t.loadAsync(a),i=[],f=Object.keys(r.files).filter(n=>{let s=n.toLowerCase();return!r.files[n].dir&&(s.endsWith(".jpg")||s.endsWith(".jpeg")||s.endsWith(".png")||s.endsWith(".webp")||s.endsWith(".gif"))}).sort(),o=0;for(let n of f){let s=await r.files[n].async("arraybuffer"),c=n.split(".").pop()?.toLowerCase()||"jpg",g=c==="png"?"image/png":c==="webp"?"image/webp":c==="gif"?"image/gif":"image/jpeg";i.push({name:n.split("/").pop()||n,data:s,type:g}),o++,this.updateProgress("extracting",`Entpacke ${e.name}...`,Math.round(o/f.length*100))}return i}async extractMetadata(e){let t=(await import("./chunk-7DPAS54S.js")).default,a=await e.arrayBuffer(),i=(await t.loadAsync(a)).file("ComicInfo.xml");return i?await i.async("string"):null}async createCBZ(e,t,a){let r=(await import("./chunk-7DPAS54S.js")).default,i=new r;if(this.updateProgress("compressing","Erstelle CBZ...",0),a){let n=a.data instanceof Blob?await a.data.arrayBuffer():a.data;i.file(`000_${a.name}`,n)}let f=String(e.length).length;for(let n=0;n<e.length;n++){let s=e[n],c=s.name.split(".").pop()||"jpg",p=`${String(n+1).padStart(f,"0")}.${c}`,B=s.data instanceof Blob?await s.data.arrayBuffer():s.data;i.file(p,B),this.updateProgress("compressing",`F\xFCge Bild ${n+1}/${e.length} hinzu...`,Math.round((n+1)/e.length*80))}t&&i.file("ComicInfo.xml",t),this.updateProgress("compressing","Finalisiere Archiv...",90);let o=await i.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}});return this.updateProgress("complete","CBZ erstellt!",100),o}detectDuplicates(e){let t=new Map;return e.map(a=>{let r=a.name.toLowerCase().replace(/\.(cbz|zip)$/i,"").replace(/[\s_-]+/g," ").trim();return t.has(r)?u(d({},a),{isDuplicate:!0}):(t.set(r,1),a)})}resetProgress(){this.updateProgress("idle","",0)}static \u0275fac=function(t){return new(t||l)};static \u0275prov=m({token:l,factory:l.\u0275fac,providedIn:"root"})};var y=class l{createObjectUrl(e,t="image/jpeg"){let a=e instanceof Blob?e:new Blob([e],{type:t});return URL.createObjectURL(a)}revokeObjectUrl(e){URL.revokeObjectURL(e)}async loadImage(e){return new Promise((t,a)=>{let r=new Image;r.crossOrigin="anonymous",r.onload=()=>{typeof e!="string"&&r.src.startsWith("blob:")&&URL.revokeObjectURL(r.src),t(r)},r.onerror=()=>a(new Error("Failed to load image")),typeof e=="string"?r.src=e:e instanceof File||e instanceof Blob?r.src=URL.createObjectURL(e):r.src=URL.createObjectURL(new Blob([e]))})}async resizeImage(e,t){let a=await this.loadImage(e),{width:r,height:i}=t,{maintainAspectRatio:f=!0}=t;if(!r&&!i)return e instanceof Blob||e instanceof File?e:new Blob([e],{type:"image/jpeg"});let o=a.width/a.height;if(f){if(r&&!i)i=Math.round(r/o);else if(i&&!r)r=Math.round(i*o);else if(r&&i){let c=r/i;o>c?i=Math.round(r/o):r=Math.round(i*o)}}r=r||a.width,i=i||a.height;let n=document.createElement("canvas");n.width=r,n.height=i;let s=n.getContext("2d");if(!s)throw new Error("Could not get canvas context");return s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(a,0,0,r,i),new Promise((c,g)=>{n.toBlob(p=>p?c(p):g(new Error("Failed to create blob")),"image/jpeg",.92)})}async getImageDimensions(e){let t=await this.loadImage(e);return{width:t.width,height:t.height}}async fetchImageFromUrl(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch image: ${t.statusText}`);return await t.blob()}static \u0275fac=function(t){return new(t||l)};static \u0275prov=m({token:l,factory:l.\u0275fac,providedIn:"root"})};export{w as a,y as b};
